name: Build and Deploy
on:
  push:
    branches:
      - master
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # https://github.com/actions/setup-node
      - name: Setup Node.js 🕸
        uses: actions/setup-node@v4
        with:
          # https://github.com/nvm-sh/nvm#long-term-support
          node-version: 'lts/*'

      - name: Set up JDK ☕️
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'
          cache: 'maven'

      - name: Install Graphviz 🐰
        run: |
          sudo apt update -y -m
          sudo apt install -y graphviz

      - name: Improve Document 📝
        run: |
          cd docs
          sed -i 's/xref:\([^\.]*\).adoc\[[^:]*\]/<<\1>>/g' *.adoc
          cd ..
      # 处理 sed 不支持非贪婪模式
      # https://stackoverflow.com/a/46719361
      # https://stackoverflow.com/a/1103159

      - name: Build 🔧
        run: |
          mvn clean package

      - name: Install Cssnano 🍻
        run: |
          npm install cssnano-cli --location=global

      - name: Compress HTML Style 🍭
        run: |
          # Multiple HTML page
          cd target/docs/multipage/assets/styles
          for f in `find . -name "*.css"`;
          do
            if [[ $f == *asciidoctor.css ]]; then
              echo -e '\na{text-decoration:none;}p>code,strong>code{color: #d14 !important;background-color: #f5f5f5 !important;border: 1px solid #e1e1e8;}' >> $f
            fi
            fn="${f%.*}.min.css";
            cssnano $f $fn;
            rm -rf $f;
            mv $fn $f
          done

      - name: Add links for comments 🔗
        run: |
          cd target/docs/multipage
          sed -i 's/\(D瓜哥 · https:\/\/www.diguage.com\)/<a href="https:\/\/www.diguage.com" class="cmt-link" target="_blank">\1<\/a>/g' *.html

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
          branch: gh-pages # The branch the action should deploy to.
          folder: target/docs/multipage # The folder the action should deploy.
          single-commit: true
