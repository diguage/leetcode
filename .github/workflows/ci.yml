name: Build and Deploy
on:
  push:
    branches:
      - master
jobs:
  build-and-deploy:
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/setup-node
      - name: Setup Node.js ğŸ•¸
        uses: actions/setup-node@v4
        with:
          # https://github.com/nvm-sh/nvm#long-term-support
          node-version: 'lts/*'

      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # https://github.com/actions/setup-java
      - name: Set up JDK â˜•ï¸
        uses: actions/setup-java@v5
        with:
#          distribution: 'temurin'
          distribution: 'corretto'
          java-version: '25'
          cache: 'maven'

      # å°† `xref` å’Œ `{doc_base_url}/` å¼•ç”¨ï¼Œåˆ‡æ¢æˆé”šç‚¹å¼•ç”¨ `<<id>>`
      # è¿™æ ·çš„è¯ï¼Œæ²¡æœ‰åšçš„é¢˜ï¼Œå› ä¸ºæ²¡æœ‰ include è¿›æ¥ï¼Œå°±æ‰¾ä¸åˆ°é”šåœ°ï¼Œæ–¹ä¾¿è¯†åˆ«
      - name: Improve Document ğŸ“
        run: |
          sed -i 's@xref:\([^\.]*\).adoc\[[^:]*\]@<<\1>>@g' docs/*.adoc
          sed -i 's@{doc_base_url}/\([^\.]*\).adoc\[[^:]*\]@<<\1>>@g' company/*.adoc
          sed -i 's@{counter:codes}@{counter:codes2503}@g' logbook/202503.adoc
      # å¤„ç† sed ä¸æ”¯æŒéè´ªå©ªæ¨¡å¼
      # https://stackoverflow.com/a/46719361
      # https://stackoverflow.com/a/1103159

      - name: Build ğŸ”§
        run: |
          mvn clean package -Pasciidoc

      - name: Add Reward Qrcode ğŸ’°
        run: |
          cd target/docs/multipage/
          sed -i 's@\(<div id="content">\)@\1<div class="sect2"><h3 id="_å‹æƒ…æ”¯æŒ">å‹æƒ…æ”¯æŒ</h3><div class="paragraph"><p>å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªç¬”è®°å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œçœ‹åœ¨Dç“œå“¥ç è¿™ä¹ˆå¤šå­—çš„è¾›è‹¦ä¸Šï¼Œè¯·å‹æƒ…æ”¯æŒä¸€ä¸‹ï¼ŒDç“œå“¥æ„Ÿæ¿€ä¸å°½ï¼ŒğŸ˜œ</p></div><table class="tableblock frame-none grid-all stretch"><colgroup><col style="width: 50%;"><col style="width: 50%;"></colgroup><tbody><tr><td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./images/alipay.png" alt="æ”¯ä»˜å®" width="85%" title="æ”¯ä»˜å®"></span></p></td><td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./images/wxpay.jpg" alt="å¾®ä¿¡" width="85%" title="å¾®ä¿¡"></span></p></td></tr></tbody></table><div class="paragraph"><p>æœ‰äº›æ‰“èµçš„æœ‹å‹å¸Œæœ›å¯ä»¥åŠ ä¸ªå¥½å‹ï¼Œæ¬¢è¿å…³æ³¨D ç“œå“¥çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡å…¬ä¼—å·çš„å›å¤ç›´æ¥ç»™æˆ‘å‘ä¿¡æ¯ã€‚</p></div><div class="paragraph"><p><span class="image"><img src="./images/wx-jikerizhi.png" alt="wx jikerizhi" width="98%"></span></p></div><div class="admonitionblock tip"><table><tbody><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content"><strong>å…¬ä¼—å·çš„å¾®ä¿¡å·æ˜¯: <code>jikerizhi</code></strong>ã€‚<em>å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œæœ‰æ—¶å›¾ç‰‡åŠ è½½ä¸å‡ºæ¥ã€‚ å¦‚æœå›¾ç‰‡åŠ è½½ä¸å‡ºæ¥å¯ä»¥ç›´æ¥é€šè¿‡æœç´¢å¾®ä¿¡å·æ¥æŸ¥æ‰¾æˆ‘çš„å…¬ä¼—å·ã€‚</em></td></tr></tbody></table></div></div>@' *.html

      - name: Add Giscus ğŸ—£ï¸
        run: |
          cd target/docs/multipage/
          # ğŸ“¢ æ³¨æ„ï¼Œæœ‰å‡ ä¸ªåœ°æ–¹éœ€è¦ä¿®æ”¹ï¼š
          # 1. ä»“åº“åœ°å€
          # 2. ä»“åº“ ID
          # 3. æ•°æ®åˆ†ç±»åç§°
          # 4. æ•°æ®åˆ†ç±» ID
          dataRepo='diguage/leetcode'
          dataRepoId='MDEwOlJlcG9zaXRvcnkxNDA4NjIxMjI='
          dataCategory='General'
          dataCategoryId='MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMTE4MDgz'
          # ğŸ“¢ æ³¨æ„ï¼Œç°åœ¨æ˜¯æå–æ–‡ä»¶åä½œä¸º Giscus å‚æ•°ï¼è¯·æ ¹æ®éœ€è¦è‡ªå®šä¹‰ Giscus å‚æ•°ã€‚
          for file in `find . -name "*.html"`;
          do
            fileBaseName=$(basename -- "$file")
            fileName="${fileBaseName%.*}"
            # https://labex.io/tutorials/shell-bash-regex-matching-391551
            # https://stackoverflow.com/a/2172365/951836
            # https://stackoverflow.com/a/2172367/951836
            if [[ "$fileName" =~ ^0000-[0-9][0-9]-.*$ ]]; then
              # https://stackoverflow.com/a/59126159/951836
              # https://www.tpointtech.com/bash-find-string
              fileName="${fileName:8:${#fileName}}"
            elif [[ "$fileName" =~ ^0000-data-structure-.*$ ]]; then
               fileName="${fileName:20:${#fileName}}"
            fi
            sed -i "s@\(<title>\)@<meta property=\"og:title\" content=\"${fileName}\">\n\1@" $file
            sed -i -z "s@\(</div>\n<div id=\"footer\">\)@<script src=\"https://giscus.app/client.js\" data-repo=\"${dataRepo}\" data-repo-id=\"${dataRepoId}\" data-category=\"${dataCategory}\" data-category-id=\"${dataCategoryId}\" data-mapping=\"og:title\" data-strict=\"0\" data-reactions-enabled=\"1\" data-emit-metadata=\"1\" data-input-position=\"top\" data-theme=\"preferred_color_scheme\" data-lang=\"zh-CN\" data-loading=\"lazy\" crossorigin=\"anonymous\" async></script>\n\1@" $file
          done

      - name: Add Tab Resource ğŸŒ—
        run: |
          cp -R docs/assets target/docs/multipage/
          cd target/docs/multipage/
          sed -i 's@>é¢˜è§£@ target="_blank">é¢˜è§£@g' logbook-*.html
          mv images/* assets/images/
          sed -i 's@src="asciidoctor-tabs.js"@src="assets/scripts/asciidoctor-tabs.js"@g' *.html
          sed -i 's@img src="./images@img src="assets/images@g' *.html

      - name: Add Scroll TOC JS ğŸŒ
        run: |
          touch target/docs/multipage/assets/scripts/scroll-toc.js
          cat > target/docs/multipage/assets/scripts/scroll-toc.js <<- EOF
            document.querySelector('#toc li a span.toc-current')
              .scrollIntoView({ behavior: "smooth", block: "center", inline: "nearest" });
          EOF
          cd target/docs/multipage/
          sed -i 's@</body>@<script src="assets/scripts/scroll-toc.js"></script></body>@g' *.html
          sed -i 's@\(.toc-current{\)@\1color:#d14;font-size:130%;@g' *.html

      - name: Rename Title ğŸ¤¡
        run: |
          cd target/docs/multipage/
          for file in ./*.html;
          do
            # https://ioflood.com/blog/bash-not-equal/
            if [ "${file}" != "./index.html" ]; then
              subtitle=$(grep '<h2.*></a>' $file | awk -F'>' '{print $4}' | awk -F'<' '{print $1}')
              echo "$file -- $subtitle"
              if [ "${subtitle}" != "" ]; then
                # å°†å˜é‡ä¸­çš„ & æ›¿æ¢ä¸º \&
                escaped_title=$(sed 's/&/\\&/g' <<< "${subtitle}") 
                sed -i "s@ è§£é¢˜ç¬”è®°</h1>@: ${escaped_title}</h1>@g" $file
                sed -i "s@ è§£é¢˜ç¬”è®°</title>@: ${escaped_title}</title>@g" $file
              fi
            fi
          done

      # https://goalsmashers.github.io/css-minification-benchmark/
      - name: Compress CSS ğŸ­
        run: |
          # https://github.com/parcel-bundler/lightningcss
          npm install -g clean-css-cli
          # Multiple HTML page
          cd target/docs/
          for f in `find . -name "*.css"`;
          do
            fn="${f%.*}.min.css";
            echo  "compress $f"
            cleancss -o $fn $f
            rm -rf $f;
            mv $fn $f
          done

      # https://github.com/privatenumber/minification-benchmarks
      - name: Compress JS ğŸ¢
        run: |
          # https://github.com/mishoo/UglifyJS
          npm install uglify-js -g
          # Multiple HTML page
          cd target/docs/
          for f in `find . -name "*.js"`;
          do
            fn="${f%.*}.min.css";
            echo  "compress $f"
            uglifyjs $f --compress --rename -o $fn 
            rm -rf $f;
            mv $fn $f
          done

      - name: Add links for comments ğŸ”—
        run: |
          cd target/docs/
          for file in `find . -name "*.html"`;
          do
            sed -i 's@\(Dç“œå“¥ Â· https://www.diguage.com\)@<a href="https://www.diguage.com" class="cmt-link" target="_blank">\1</a>@g' $file
          done

      # https://github.com/JamesIves/github-pages-deploy-action
      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
          branch: gh-pages # The branch the action should deploy to.
          folder: target/docs/multipage # The folder the action should deploy.
          single-commit: true
